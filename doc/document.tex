\documentclass{article}
  \parindent = 0mm % Sin sangría
  \usepackage[utf8]{inputenc}
  \usepackage[T1]{fontenc}
  \usepackage[spanish]{babel}
  \usepackage{graphicx}
  \usepackage{amstext}
  \usepackage{amsmath}
  \usepackage{booktabs}
  \usepackage{subfigure}
  \usepackage{footnote}
  \usepackage{hyperref}
  \usepackage{algpseudocode,algorithm,algorithmicx}
  \usepackage[font=small,labelfont=bf]{caption}

\begin{document}
  \begin{center}
    {\sc \large Enfoque de pulsos}
    
    {\sc \large Proyecto 2020}
    \linebreak

    {\rm Joaquín Correa - \today}
  \end{center}

  \section*{Introducción}

  Como proyecto de aplicación del algorítmo del Pulso propongo su aplicación al problema de ruteo de demanda y decisión de construcción de ciclovías en una ciudad, puede ser visto como una versión del problema de distribución de mercancías, sobre una red que puede ser mejorada mediante la construcción de instalaciones que mejoren la distribución. Utilizo el pulso como método alternativo a la programación matemática con el objetivo de escalar mejor en el tamaño de las instancias atacables, aunque con esto se pueda perder la exactitud de la solución, es decir lo utilizo como heurístca. Finalmente realizo un comparación en medida de lo posible con el MILP que resuelve el problema exacto e incluyo una sección con características propias y trabajo futuro.

  \section*{Problema}

  El problema consiste en decidir dónde construir ciclovías de manera que satisfaga las necesidades de los usuarios, representados por la demanda, de la mejor manera. Matemáticamente, el modelo consiste en un grafo dirigido y un conjunto de pares origen-destino donde para cada uno se tiene un valor de demanda (por ejemplo cantidad de personas). Para cada arco del grafo, se tiene un costo de usuario que corresponde al costo percibido por un usuario si lo utiliza para desplazarse y un costo de construcción de diversos tipos de ciclovías. Al construir una ciclovía sobre un arco, el costo de usuario disminuye. Finalmente se tiene un valor de presupuesto que limita la construcción de ciclovías.

  La formulación matemática es la siguiente:

  \begin{align}
    \text{min} & \sum_{k \in O} \sum_{i \in I} \sum_{e \in E} x_{ek}^i c_e^i & \label{eq:objective} \\
    \text{s.t.} & \sum_{i \in I}\sum_{e \in E_n^+} x_{ak}^i - \sum_{i \in I}\sum_{e \in E_n^-} x_{ak}^i = b_{nk} & \forall k \in O, n \in V \label{eq:flowconservation} \\
          & \sum_{i \in I} y_{e}^i \leq 1 & \forall e \in E \label{eq:onlyoneinfraactive} \\
          & \sum_{i \in I} \sum_{e \in E} m_e^i y_e^i \leq B & \label{eq:respectbudget} \\
          & x_{ek}^i \leq y_e^i  D_k & \forall e \in E, i \in I, k \in O \label{eq:restrictflowbyinfras} \\
          & x_{ek}^i \geq 0, y_e^i \in \{0,1\} &
  \end{align}

  Donde:
  \begin{description}
    \item[$O$]: Conjunto de pares origen-destino.
    \item[$I$]: Conjunto de infraestructuras.
    \item[$G=(V, E)$]: Grafo dirigido, compuesto por el conjunto de vértices $V$ y arcos $E$.
    \item[$c_e^i$]: Parámetro, costo de usuario de atravesar el arco $e$ utilizando la infraestructura $i$.
    \item[$b_{nk}$]: Parámetro, valor de la ecuación de conservación del flujo. Vale $D_k$ si $n$ es el origen de $k$, $-D_k$ si es el destino y cero en otro caso.
    \item[$m_e^i$]: Parámetro, costo de construcción de la infraestructura $i$ sobre el arco $e$.
    \item[$B$]: Parámetro, valor del presupuesto total de construcción.
    \item[$x_{ek}^i$]: Es la variable que modela el flujo de demanda del par origen-destino $k$, sobre el arco $e$ utilizando la infraestructura $i$.
    \item[$y_e^i$]: Es la variable binaria que indica si la infraestructura $i$ está activa en el arco $e$.
  \end{description}

  Y las ecuaciones:

  \begin{description}
    \item[(\ref{eq:objective})] Objetivo, se minimiza el costo total percibido por el flujo.
    \item[(\ref{eq:flowconservation})] Restricción de conservación del flujo.
    \item[(\ref{eq:onlyoneinfraactive})] Restricción que permite solo una infraestructura activa por arco.
    \item[(\ref{eq:respectbudget})] Restricción de presupuesto.
    \item[(\ref{eq:restrictflowbyinfras})] Restricción que permite al flujo utilizar la infraestructura activa únicamente.
  \end{description}

  \subsection*{Modelado}

  Se puede observar de la formulación, que si bien el grafo base es un grafo simple, se está trabajando sobre un multigrafo. Cada arco del grafo base es replicado tantas veces como cantidad de infraestructuras hay y cada replica tiene un costo de usuario y costo de construcción asociado.

  Lo que se busca son caminos óptimos por este multigrafo, con restricción de presupuesto, que determina para cada par de nodos, qué arco se elije, si se elije alguno. Notar que si se activa la infraestructura $i$ en el arco $e$, esta puede ser usada por cualquiera de los flujos entre pares origen-destino.

  Una cosa que no esta representada en el modelo, pero que se desprende de la realidad, es que siempre habrá una solución factible. Esto es debido a que se toma el grafo base como una de las infraestructuras cuyo costo de construcción es cero.

  \subsection*{Dificultades}

  Este problema, asi como fué formulado puede resolverse en un MILP solver para grafos no muy grandes de manera conveniente. Pero, al ser en parte un problema de programación entera sabemos es un problema contenido en $NP$ y por lo tanto, todavía, difícil de escalar.

  Particionando el problema en dos, con el solo objetivo de analizarlo, por un lado esta la decisión de cuál y dónde construir infraestructura y por otro la de encontrar el camino más corto para cada par origen-destino. La primera partición del problema es la difícil, la segunda, vista de manera aislada es un problema {\it fácil}: el flujo entre dos pares origen destino no esta relacionado con otros flujos, ni los arcos tienen capacidad. Por lo tanto, la segunda partición es simplemente el problema del camino mas corto entre dos puntos, repetido $card(O)$ veces. Lo que se busca en este trabajo, es utilizar el pulso para resolver ambos problemas al mismo tiempo.

  \section*{Aplicación del Pulso}

  Supongamos para simplificar, que tenemos un único par origen-destino. Debemos encontrar la asignación de infraestructuras a arcos que hagan mejor uso del presupuesto $B$. Si modelamos el grafo con infraestructuras como un multigrafo, esto se puede resolver como un problema de camino más corto con restricciónes o weighted-constrained shortest-path. Aquí es donde entra el algorítmo del Pulso.

  Es de suponer, que en la simplificación de un único par origen-destino, el pulso, o cualquier algorítmo exacto para el WCSP debe encontrar la mejor solución, la misma que encontraría el MILP solver. Ahora, si consideramos mas de un par origen-destino la cosa cambia.

  Si bien los pares origen-destino son independientes, la red subyacente es común, y el hecho de que una infraestructura esté activa o no en cierto arco puede determinar el camino mas corto entre varios pares origen-destino. Supongamos que se toma un par origen-destino y se ejecuta el pulso con cierta restricción de presupuesto. Luego se toma el siguiente par origen-destino y se ejecuta el pulso, con cierta restricción de presupuesto, si es que aún queda, y sobre el multigrafo luego de aplicar las infraestructuras que el pulso eligió para el primer par origen-destino. Se puede continuar este proceso iterativo hasta quedarse sin pares origen-destino. El hecho de quedarse sin presupuesto no afecta en lo mas mínimo, debido a que siempre habrán caminos cuyos costo de construcción sean cero. A grandes rasgos, este fue el camino que se siguió.

  Lo que queda por definir es la asignación de presupuesto para cada ejecución del pulso. Se decidió asignar a cada origen-destino la proporción de presupuesto relativa a la demanda de dicho par sobre el total, es decir: el presupuesto del par $k$ es $B_k = B  {D_k \over \sum_{s \in O} D_s}$.

  \subsection*{Consideraciones del pulso}

  Se implementó una versión del pulso simple que incluye las siguientes características:

  \begin{description}
    \item[Poda por costo]: {se corre inicialmente un Dijkstra sobre el reverso del grafo base\footnote{El grafo con los arcos en sentido opuesto}, para obtener una cota inferior del costo desde cada nodo al nodo objetivo. Luego se utiliza esta información para realizar la poda por costo.}
    \item[Poda por infactibilidad]: {se corre, para cada restricción, un Dijkstra sobre el grafo reverso tomando dicha restricción como el costo de los arcos. De esta forma obtenemos un valor mínimo de cada restricción requerido para llegar al nodo destino.}
    \item[Poda por dominancia]: {cuando un pulso llega a un nodo, se verifica que dicho pulso no esté dominado por algún otro pulso que ya se encuentre en el nodo.}
    \item[Cola de pulsos]: {En cada iteración, el pulso elegido es el que tiene menor costo proyectado. Es decir, cuyo costo actual mas la cota inferior del costo en el nodo, es menor.}
  \end{description}

  \subsection*{Modos de ejecución}

  \subsection*{Pulse Solver}

  El algoritmo que soluciona el problema, llamemoslo {\it Pulse solver}, se implementó como un algoritmo recursivo que en cada paso recursivo selecciona un par origen destino, corre el pulso y para cada camino generado, lo aplica al grafo, llama al paso recursivo y luego vuelve el grafo a su estado inicial. El solver puede tener una cantidad exponencial (en la cantidad de pares origen-destino) de pasos recursivos, si el pulso genera muchos caminos en cada paso. Por eso necesario que cada camino generado por el pulso sea lo mejor posible. Más allá de los caminos que pueda generar el pulso en cada paso, se puede limitar la cantidad considerada con un parámetro del programa.

  Cada ejecución del árbol de recursiones es considerada una iteración. Se puede configurar la cantidad de iteraciones a realizar el algorítmo. En cada iteración, la secuencia en que son elegidos los pares origen destino es aleatorizada.

  Para flexibilizar un poco el presupuesto asignado a cada pulso, se pueden especificar dos numeros $P_{\alpha}$ y $P_{\beta}$ de manera que el presupuesto asignado al par origen destino $o$, sea $BP_oP_{\alpha} + P_{\beta}$, donde $P_o$ es la proporción del total del presupuesto total $B$ asignado a $o$. Esto puede causar que el o los ultimos pares origen-destino considerados en la recursión tengan presupuesto $0$, pues este se asigno completamente a pares origen-destino anteriores en la recursión.

  \subsection*{Pulso}

  El algoritmo del pulso requiere cuatro parámetros en su forma mas básica: el grafo, las restricciones y los nodos origen y destino. Se implementó de manera que sea mas bien un generador de caminos entre los nodos origen y destino. Para limitar la cantidad de caminos generados se puede puede incluir un parámetro que indica el costo máximo que deben tener los caminos generados y también existe la posibilidad de que devuelva unicamente el mejor. Estos últimos parámetros son de utilidad ya que la complejidad de buscar la mejor solución es mucho mayor que buscar una solución suficientemente buena, como se describirá en la sección de resultados.

  \subsection*{Otras opciones}

  \begin{description}
    \item[Descartar nodos mas lejanos:] Booleano, por defecto falso. Durante la ejecución del pulso, no considera nodos cuya cota mínima de costo sea mayor a la del pulso corriente. Esto puede ser deseado o no dependiendo del conjunto de datos.
    \item[Delta de descarte de nodos mas lejanos:] Numero, valor de la diferencia a prtir del cual se descartan nodos mas lejanos. También puede ser usado para forzar la elecciones de nodos mas cercanos, si se utiliza un valor negativo.
  \end{description}

  \section*{Casos de estudio}

  En esta sección se comparan los tiempos y las variables obtenidas de la ejecución de los solvers GLPK\footnote{Gnu Linear Programing Kit} y CBC\footnote{Coin-or branch and cut} y el Pulse solver. Sobre el último, se detallará para cada caso la configuración utilizada.

  Los MILP solvers son ejecutados con la opcion de utilizar métodos de Cutting-Plane, lo que mejora considerablemente su tiempo de ejecución frente al Branch and Cut.

  \subsection*{Ciudad Vieja}

  El primer nivel de comparación y ejecución del modelo se realizó con un grafo que representa aproximadamente\footnote{Se generó a partir de información de cruces de calles} el barrio Ciudad Vieja de Montevideo. En este grafo todas las calles van en ambas direcciones. Cuenta con 204 nodos y 770 arcos y su inexacta representación esta en la figura.

  \begin{figure}[h!]
    \centering
    \includegraphics[width=6cm]{imgs/mdeo_med_base.png}
    \caption{Grafo de Ciudad Vieja, 204 nodos y 770 arcos. Los arcos negros marcan el camino más corto sobre el grafo base entre los cuatro pares origen destino. Notar que estos caminos pueden estar cortados ya que hay arcos solapados debido a errores en la generación del grafo base, lo que causa que el arco pintado de negro quede debajo del gris.}
    \label{ciudadvieja}
  \end{figure}

  Para este caso de prueba, se eligieron cuatro pares origen destino y un presupuesto de $15000$. En la tabla \ref{table:odsciudadvieja} se pueden observar los pares origen-destino elegido y el costo del camino mas corto sobre el grafo base. El valor objetivo en el grafo base es de $1.496.098,44$.

  \begin{table}[h!]
    \centering
    \begin{tabular}{ccc}
      \toprule
      Par OD & Demanda & Mejor costo base \\
      \midrule
      0 & 500 & 1585,97 \\
      1 & 50 & 1078,17 \\
      2 & 100 & 713,04 \\
      3 & 250 & 1651,14 \\
      \bottomrule
    \end{tabular}
    \caption{Resumen de pares origen-destino considerados para Ciudad Vieja. Estos datos de fueron elegidos de forma manual.}\label{table:odsciudadvieja}
  \end{table}
  
  Ademas, se especificaron tres infraestructuras a construir, que junto a la infraestructura base quedan en cuatro. Los factores de mejora sobre el costo de usuario se especifican en la tabla \ref{table:infrasciudadvieja}.

  \begin{table}[h!]
    \centering
    \begin{tabular}{ccc}
      \toprule
      Infrastructura & Costo de usario & Costo de construcción \\
      \midrule
      base & c & c \\
      0 & 0.9c & c \\
      1 & 0.5c & 4c \\
      2 & 0.4c & 8c \\
      \bottomrule
    \end{tabular}
    \caption{Resumen de infraestructuras consideradas para Ciudad Vieja.}\label{table:infrasciudadvieja}
  \end{table}

  Utilizando ambos MILP solvers se pudo obtener una solución en poco tiempo. Por otra parte el Pulse solver requirió de muchas pruebas hasta llegar a una configuración que ejecute de manera aceptablemente rápida y encuentre una solución medianamente buena. Si utilizamos la configuración para buscar el mejor camino, entonces el tiempo de ejecución del pulse solver se dispara indefinidamente. Por otra parte se probó un factor de mejora de $0.9$ que también resultó en un tiempo de ejecución excesivo, esta vez debido a que no es posible encontrar una solución que mejore en un $10\%$ el camino mas corto de uno de los pares origen-destino ya que su demanda es muy baja y por lo tanto el presupuesto asignado es insuficiente para lograr esta mejora. Luego de varias pruebas, se obtuvo un resultado medianamente bueno en tiempo de ejecución aceptable utilizando $P0.97$, ignorando nodos más lejanos en el pulso, un delta en el presupuesto por par origen-destino de $500$, dos caminos por par origen-destino y cuatro iteraciones del solver.
  
  En la tabla \ref{table:resultadosciudadvieja} se muestra un breve resumen de los tiempos de ejecución y los valores objetivos. Luego en la figura \ref{resultadosciudadvieja} se muestran las decisiones sobre las infraestructuras tomadas por cada solver en el grafo. Se observa en la figura de representación de los resultados que la solución exacta asigna todos los recursos a las demandas de mayor valor, que son la que recorre el borde superior y la que recorre los bordes inferior y derecho.

  \begin{table}[h!]
    \centering
    \begin{tabular}{cccc}
      \toprule
      Solver & Tiempo ejecución (s) & Valor objetivo & Presupuesto \\
      \midrule
      GLPK & 94,5 & 763589,7502 & 14997.77 \\
      CBC & 41,33 & 763589,7502 & - \\
      Pulse & 106,43 & 942412,8526 & 14995.47 \\
      \bottomrule
    \end{tabular}
    \caption{Resumen de ejecución para el grafo de Ciudad Vieja.}\label{table:resultadosciudadvieja}
  \end{table}

  \begin{figure}[h!]
    \centering
    \includegraphics[width=6cm]{imgs/mdeo_med_glpk.png}
    \includegraphics[width=6cm]{imgs/mdeo_med_pulse.png}
    \caption{A la izquierda las infraestructuras construidas por GLPK. A la derecha las construidas por el pulse solver. Los colores de las infraestructuras son: gris, verde, rojo y azul respectivamente al orden en que fueron definidas.}
    \label{resultadosciudadvieja}
  \end{figure}

  \subsection*{Montevideo}

  Como caso de estudio mas complejo se tomó una región más grande de la ciudad de Montevideo, la cual contiene a Ciudad Vieja. Para este grafo se eligieron cinco pares origen-destino (detallados en la tabla \ref{table:odsmontevideo}) y un presupuesto de $50.000$. Las infraestructuras y sus costos son los mismas que para el caso de Ciudad Vieja.

  \begin{table}[h!]
    \centering
    \begin{tabular}{ccc}
      \toprule
      Par OD & Demanda & Mejor costo base \\
      \midrule
      0 & 1540 & 4548,58 \\
      1 & 1333 & 2158,91 \\
      2 & 218 & 2158,91 \\
      3 & 650 & 6468,50 \\
      4 & 1859 & 7112,83 \\
      \bottomrule
    \end{tabular}
    \caption{Resumen de los pares origen-destino considerados para Montevideo. Estos fueron generados aleatoriamente.}\label{table:odsmontevideo}
  \end{table}

  La representación del grafo y los caminos más cortos sobre el grafo base se pueden observar en la figura \ref{montevideo}. En este caso el valor de la función objetivo base es de $28.253.371,82$.

  \begin{figure}[h!]
    \centering
    \includegraphics[width=8cm]{imgs/mdeo_large_base.png}
    \caption{Grafo de Montevideo, cuenta con 3894 nodos y 15274 arcos. Los arcos rojos marcan el camino más corto sobre el grafo base entre los pares origen destino. A diferencia del caso de Ciudad Vieja.}
    \label{montevideo}
  \end{figure}

  \section*{Implementación}

  \section*{Trabajo futuro}

  Este trabajo es una prueba de concepto que evidentemente puede ser mejorada y extendida. Aquí se detallan algunos puntos en este sentido.

  \subsection*{Forzar mejores soluciones por par origen-destino}

  El parámetro para configurar la ganancia sobre el costo base por par origen-destino debería ser configurado para cada par. El problema con la forma de dividir el presupuesto es que pueden haber pares origen-destino con muy poca demanda relativa al total, que por lo tanto no logran un asignación de presupuesto que permita obtener la ganancia impuesta por el parámetro. Esto puede causar que no exista solución para algún par origen-destino, lo que causa un infructuoso y largo tiempo de ejecución.

  \subsection*{Mejorar poda por costo}

  La poda por costo puede ser mejorada de manera que se poden pulsos mas tempranamente. La poda actual solo considera la cota mínima del costo para obtener un costo mínimo proyectado hasta el destino. Sin embargo, este costo mínimo puede que sea inalcanzable debido a que los recursos que requiere no son factibles al sumarlos al pulso que se compara.

  \subsection*{Implementación más rápida}

  Para este estudio se utilizó python como lenguaje de implementación, que permite un rápido desarrollo y puesta en funcionamiento pero no es tan bueno en términos de eficiencia en el cómputo. Una implementación en un lenguaje de mas bajo nivel puede lograr mejoras considerables en el tiempo de ejecución.

  \subsection*{Version estocástica}

  Probar el mismo problema pero con una version estocástica del Pulso. Bastaría con cambiar la implementación de la cola de pulsos a una que utilice cierto grado de aleatoriedad.

\end{document}
